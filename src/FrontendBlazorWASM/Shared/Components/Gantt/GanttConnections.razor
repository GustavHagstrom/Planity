@using System.Globalization
@using Planity.FrontendBlazorWASM.Shared.Components.Gantt

@foreach (var conn in GetConnections())
{
    <GanttConnection Points="@conn.Points" StrokeColor="#3a6ea5" StrokeWidth="2" MarkerEnd="url(#arrowhead)" />
}

@code {
    [Parameter] public IEnumerable<IGanttItem> Items { get; set; } = Enumerable.Empty<IGanttItem>();
    [Parameter] public GanttView View { get; set; } = null!;

    private record Connection(string Points);

    private List<Connection> GetConnections()
    {
        var connections = new List<Connection>();
        var itemsWithLevel = GanttItemUtils.ItemsWithExpandLevel(Items).ToList();
        var itemIndex = itemsWithLevel.Select((tuple, idx) => new { tuple.item, idx }).ToDictionary(x => x.item, x => x.idx);

        for (int index = 0; index < itemsWithLevel.Count; index++)
        {
            var (item, level) = itemsWithLevel[index];
            if (item.Predecessors == null) continue;
            foreach (var predecessor in item.Predecessors)
            {
                if (!itemIndex.TryGetValue(predecessor, out var predIndex)) continue;
                var (predX, predY) = GetHandlePosition(predecessor, predIndex, true);
                var (itemX, itemY) = GetHandlePosition(item, index, false);
                var points = $"{predX},{predY} {itemX},{predY} {itemX},{itemY}";
                connections.Add(new Connection(points));
            }
        }
        return connections;
    }

    // isEndHandle: true för predecessor, false för item
    private (string x, string y) GetHandlePosition(IGanttItem item, int index, bool isEndHandle)
    {
        if (item.Type == GanttItemType.Milestone && item.Start != null)
        {
            var centerX = ((item.Start.Value - View.Start).TotalDays * View.PixelsPerDay) + (View.RowHeight / 2);
            var centerY = (index * View.RowHeight) + (View.RowHeight / 2);
            return (centerX.ToString(CultureInfo.InvariantCulture), centerY.ToString(CultureInfo.InvariantCulture));
        }
        else if (item.Start != null && item.End != null)
        {
            var x = ((item.Start.Value - View.Start).TotalDays * View.PixelsPerDay);
            var width = ((item.End.Value - item.Start.Value).TotalDays * View.PixelsPerDay);
            var handleRadius = 5;
            var y = (index * View.RowHeight) + (View.RowHeight / 2);
            if (isEndHandle)
                return ((x + width - handleRadius).ToString(CultureInfo.InvariantCulture), y.ToString(CultureInfo.InvariantCulture));
            else
                return ((x + handleRadius).ToString(CultureInfo.InvariantCulture), y.ToString(CultureInfo.InvariantCulture));
        }
        return ("0", "0");
    }
}
