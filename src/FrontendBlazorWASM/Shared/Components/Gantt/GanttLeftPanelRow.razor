@using Planity.FrontendBlazorWASM.Shared.Abstractions
@using Microsoft.AspNetCore.Components

<style>
    .gantt-leftpanel-row {
        width: 100%;
        position: relative;
        cursor: pointer;
        transition: box-shadow 0.2s, border 0.2s;
        display: flex;
        align-items: center;
    }

    .gantt-leftpanel-row.gantt-leftpanel-selected {
        background-color: transparent;
        box-shadow: 0 0 8px 2px #3a6ea5;
        font-weight: bold;
    }

    .gantt-leftpanel-row.gantt-leftpanel-child {
        padding-left: 24px;
        border-left: 2px solid #3a6ea5;
        background: rgba(58, 110, 165, 0.05);
    }

    .gantt-leftpanel-toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        margin-right: 4px;
        font-size: 16px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="@RowClass" style="height: @RowHeightPx;" @onclick="HandleRowClick">
    @if (HasChildren)
    {
        <button class="gantt-leftpanel-toggle-btn" @onclick:stopPropagation="true" @onclick="ToggleExpand">
            @(Item.IsExpanded ? "▼" : "▶")
        </button>
    }
    @Item.Name
</div>
@if (HasChildren && Item.IsExpanded)
{
    @foreach (var child in Item.Children ?? Enumerable.Empty<IGanttItem>())
    {
        <GanttLeftPanelRow Item="child" Level="@(Level + 1)" RowHeightPx="@RowHeightPx" SelectedItem="SelectedItem" OnRowClick="OnRowClick" OnExpandCollapse="OnExpandCollapse" />
    }
}

@code {
    [Parameter] public IGanttItem Item { get; set; } = default!;
    [Parameter] public int Level { get; set; } = 0;
    [Parameter] public string RowHeightPx { get; set; } = "30px";
    [Parameter] public IGanttItem? SelectedItem { get; set; }
    [Parameter] public EventCallback<IGanttItem> OnRowClick { get; set; }
    [Parameter] public EventCallback OnExpandCollapse { get; set; }

    private bool IsSelected => SelectedItem == Item;
    private bool HasChildren => Item.Children != null && Item.Children.Any();
    private string RowClass => $"gantt-leftpanel-row{(IsSelected ? " gantt-leftpanel-selected" : "")}{(Level > 0 ? " gantt-leftpanel-child" : "")}";

    private async Task HandleRowClick()
    {
        await OnRowClick.InvokeAsync(Item);
    }

    private async Task ToggleExpand()
    {
        Item.IsExpanded = !Item.IsExpanded;
        await OnExpandCollapse.InvokeAsync();
    }
}
