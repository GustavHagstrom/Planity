@using System.Globalization
@using Planity.FrontendBlazorWASM.Shared.Components.Gantt
@inject IStringLocalizer<GanttHeader> Localizer

<svg style="height: @HeaderHeightPx; width: @SvgWidthPx;">
    @foreach (var segment in GetHeaderSegments())
    {
        @segment
    }
    @GanttSvgHelper.RenderLine(0, SvgWidthPxNum, HeaderHeight / 2, HeaderHeight / 2, "black", 1)
    @GanttSvgHelper.RenderLine(0, SvgWidthPxNum, HeaderHeight, HeaderHeight, "black", 1)
</svg>

@code {
    [Parameter] public DateTime Start { get; set; }
    [Parameter] public DateTime End { get; set; }
    [Parameter] public GanttViewMode Mode { get; set; } = GanttViewMode.Month;
    [Parameter] public double PixelsPerDay { get; set; } = 30;
    [Parameter] public double HeaderHeight { get; set; } = 50;
    [Parameter] public string HeaderHeightPx { get; set; } = "50px";
    [Parameter] public string SvgWidthPx { get; set; } = "600px";
    private double SvgWidthPxNum => double.TryParse(SvgWidthPx.Replace("px", ""), out var val) ? val : 600;
    int DaysToNextYear(DateTime date)
    {
        var nextYear = new DateTime(date.Year + 1, 1, 1);
        return (nextYear - date).Days;
    }

    IEnumerable<MarkupString> GetHeaderSegments()
    {
        if (Mode == GanttViewMode.Year)
        {
            foreach (var s in GetYearSegments()) yield return s;
            foreach (var s in GetMonthSegments(false)) yield return s;
        }
        else if (Mode == GanttViewMode.Month)
        {
            foreach (var s in GetMonthSegments(true)) yield return s;
            foreach (var s in GetWeekSegments()) yield return s;
        }
        else // Week
        {
            foreach (var s in GetWeekSegments(true)) yield return s;
            foreach (var s in GetDaySegments()) yield return s;
        }
    }

    IEnumerable<MarkupString> GetYearSegments()
    {
        var currentDate = Start;
        while (currentDate < End)
        {
            var daysToNextYear = DaysToNextYear(currentDate);
            var daysToEnd = (End - currentDate).Days;
            var daysToRender = Math.Min(daysToNextYear, daysToEnd);
            var width = daysToRender * PixelsPerDay;
            var height = HeaderHeight / 2;
            
            var startX = (currentDate - Start).TotalDays * PixelsPerDay;

            var textX = startX + (daysToRender * PixelsPerDay / 2);
            var year = currentDate.ToString("yyyy", CultureInfo.InvariantCulture);
            yield return GanttSvgHelper.RenderRect(startX, 0, width, height, "pink");
            yield return GanttSvgHelper.RenderLine(startX, startX, 0, height, "black", 0.5);
            yield return GanttSvgHelper.RenderText(textX, 18, year);
            currentDate = currentDate.AddDays(daysToRender);
        }
    }

    IEnumerable<MarkupString> GetMonthSegments(bool onTop = false)
    {
        var currentDate = Start;
        while (currentDate < End)
        {
            var startX = (currentDate - Start).TotalDays * PixelsPerDay;
            var monthDays = DateTime.DaysInMonth(currentDate.Year, currentDate.Month);
            var daysToNextMonth = monthDays - (currentDate.Day - 1);
            var width = daysToNextMonth * PixelsPerDay;
            var height = HeaderHeight / 2;
            var monthText = currentDate.ToString(onTop ? "MMMM" : "MMM", CultureInfo.InvariantCulture);
            var y = onTop ? 0 : height;
            var textY = onTop ? 18 : height + 18;
            var textX = startX + (width / 2);
            var fillColor = onTop ? "goldenrod" : "lightblue";
            yield return GanttSvgHelper.RenderRect(startX, y, width, height, fillColor);
            yield return GanttSvgHelper.RenderLine(startX, startX, y, y + height, "black", 0.5);
            yield return GanttSvgHelper.RenderText(textX, textY, monthText);
            currentDate = currentDate.AddDays(daysToNextMonth);
        }
    }

    IEnumerable<MarkupString> GetWeekSegments(bool onTop = false)
    {
        var currentDate = Start;
        while (currentDate < End)
        {
            var startX = (currentDate - Start).TotalDays * PixelsPerDay;
            var weekNumber = CultureInfo.InvariantCulture.Calendar.GetWeekOfYear(currentDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
            var daysToNextWeek = 7 - (int)currentDate.DayOfWeek;
            var width = daysToNextWeek * PixelsPerDay;
            var height = HeaderHeight / 2;
            var weekText = onTop ? $"{Localizer["Vecka"]}: {weekNumber}" : Localizer["v."] + $" {weekNumber}";
            var y = onTop ? 0 : height;
            var textY = onTop ? 18 : height + 18;
            var fill = onTop ? "lightgreen" : "lightblue";
            yield return GanttSvgHelper.RenderRect(startX, y, width, height, fill);
            yield return GanttSvgHelper.RenderLine(startX, startX, y, y + height, "black", 0.5);
            yield return GanttSvgHelper.RenderText(startX + (width / 2), textY, weekText);
            currentDate = currentDate.AddDays(daysToNextWeek);
        }
    }

    IEnumerable<MarkupString> GetDaySegments()
    {
        var currentDate = Start;
        while (currentDate < End)
        {
            var startX = (currentDate - Start).TotalDays * PixelsPerDay;
            var dayText = currentDate.ToString("ddd");
            var textX = startX + (PixelsPerDay / 2);
            yield return GanttSvgHelper.RenderRect(startX, HeaderHeight / 2, PixelsPerDay, HeaderHeight / 2, "lightblue");
            yield return GanttSvgHelper.RenderLine(startX, startX, HeaderHeight / 2, HeaderHeight, "black", 0.5);
            yield return GanttSvgHelper.RenderText(textX, HeaderHeight / 2 + 18, dayText);
            currentDate = currentDate.AddDays(1);
        }
    }
}
