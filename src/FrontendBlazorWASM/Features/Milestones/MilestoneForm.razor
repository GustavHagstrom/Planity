<MudForm @ref="form" @bind-IsValid="@IsValid">
    <MudStack Spacing="2">
        <PlanityTextField T="string" @bind-Value="Milestone.Name" Label="Namn" For="() => Milestone.Name" Required="true" />
        <PlanityTextField T="string" @bind-Value="Milestone.Description" Label="Beskrivning" For="() => Milestone.Description" />
        <MudDatePicker Date="Milestone.Start" DateChanged="OnDateChanged" Label="Datum" Margin="Margin.Dense" Variant="Variant.Outlined" />
        <MudTimePicker Time="Milestone.Start?.TimeOfDay" TimeChanged="OnTimeChanged" Label="Tid" Margin="Margin.Dense" Variant="Variant.Outlined" />

        <MudAutocomplete T="Project" Value="project" ValueChanged="SetSelectedProject" Label="@Localizer["Projekt"]" Dense="true" Margin="Margin.Dense" SearchFunc="SearchProjects" ToStringFunc="x => x.Name" Clearable="true" Required="true"/>
    </MudStack>
</MudForm>

@inject IProjectService ProjectService
@inject IStringLocalizer<MilestoneForm> Localizer

@code {
    [Parameter] public Milestone Milestone { get; set; } = new();
    [Parameter] public string? ProjectId { get; set; }


    MudForm? form;
    Project? project;
    List<Project> projects = new();

    public bool IsValid { get; set; }
    public void Validate() => form?.Validate();

    void OnDateChanged(DateTime? value)
    {
        Milestone.Start = value?.Date + (Milestone.Start?.TimeOfDay ?? TimeSpan.Zero);
    }
    void OnTimeChanged(TimeSpan? value)
    {
        Milestone.Start = Milestone.Start?.Date + (value ?? TimeSpan.Zero);
    }

    protected override async Task OnInitializedAsync()
    {
        projects = await ProjectService.GetAllAsync();
        if (!string.IsNullOrWhiteSpace(Milestone.ProjectId))
        {
            project = projects.FirstOrDefault(p => p.Id == Milestone.ProjectId);
        }
        else if (!string.IsNullOrWhiteSpace(ProjectId))
        {
            project = projects.FirstOrDefault(p => p.Id == ProjectId);
            Milestone.ProjectId = ProjectId;
        }
    }

    void SetSelectedProject(Project? selectedProject)
    {
        project = selectedProject;
        Milestone.ProjectId = selectedProject?.Id ?? string.Empty;
    }
    Task<IEnumerable<Project>> SearchProjects(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(projects.AsEnumerable());
        return Task.FromResult(projects.Where(p => p.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }
}
