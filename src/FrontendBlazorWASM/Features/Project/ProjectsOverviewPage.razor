@page "/projects"
@inject NavigationManager NavigationManager
@inject IStringLocalizer<ProjectsOverviewPage> localizer
@inject IResourceService ResourceService
@inject IDateCalculator GanttDateCalculator
@inject IProjectService ProjectService
@inject GanttViewStateContainer GanttViewState

<OverviewPageLayout Title="@localizer["Projektöversikt"]" Class="d-flex">
    <LeftActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo(Planity.FrontendBlazorWASM.Routes.ProjectsNew))" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add" >
            <span>@localizer["Nytt projekt"]</span>
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@ViewSelectionInGantt" Size="Size.Small" StartIcon="@Icons.Material.Filled.ViewTimeline">
            <span>@localizer["Visa urval i Gantt"]</span>
        </MudButton>
    </LeftActions>
    <MiddleActions>

    </MiddleActions>
    <RightActions>
        <PlanitySearchField @bind-Value="FilterString" />
    </RightActions>

    <ChildContent>
        <MudContainer>
            <EntityTable Items="@Projects" Filter="FilterFunction">
                <HeaderContent>
                    <MudTh>
                        <MudStack Spacing="0" Style="max-width: 200px;">
                            <MudText><b>Namn</b></MudText>
                            <PlanityFilterField @bind-Value="@NameFilter" />
                        </MudStack>
                    </MudTh>
                    <MudTh>
                        <MudStack Spacing="0" Style="max-width: 200px;">
                            <MudText><b>Beskrivning</b></MudText>
                            <PlanityFilterField @bind-Value="@DescriptionFilter" />
                        </MudStack>
                    </MudTh>
                    <MudTh>
                        <MudStack Spacing="0" Style="max-width: 200px;">
                            <MudText><b>Start</b></MudText>
                            <MudDatePicker @bind-Date="@FromDateFilter" Placeholder="Från" Variant="Variant.Outlined" Margin="Margin.Dense" OpenTo="OpenTo.Month" Clearable="true" Editable="true"/>
                        </MudStack>
                    </MudTh>
                    <MudTh>
                        <MudStack Spacing="0" Style="max-width: 200px;">
                            <MudText><b>Slut</b></MudText>
                            <MudDatePicker @bind-Date="@ToDateFilter" Placeholder="Till" Variant="Variant.Outlined" Margin="Margin.Dense" OpenTo="OpenTo.Month" Clearable="true" Editable="true"/>
                        </MudStack>
                    </MudTh>
                    <MudTh>
                        <MudStack Spacing="0">
                            <MudText><b>Handlingar</b></MudText>
                            <MudField Variant="Variant.Outlined" Margin="Margin.Dense" Style="visibility: hidden;" />
                        </MudStack>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>@context.Description</MudTd>
                    <MudTd>@context.Start?.ToShortDateString()</MudTd>
                    <MudTd>@GanttDateCalculator.CalculateEnd(context, Resources)?.ToShortDateString()</MudTd>
                    <MudTd>
                        <MudIconButton Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Sharp.Edit" Href="@Routes.ProjectDetails(context.Id)" />
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Sharp.Delete" Color="Color.Error" />
                    </MudTd>
                </RowTemplate>
            </EntityTable>
        </MudContainer>
            
    </ChildContent>
</OverviewPageLayout>


@code {
    private List<Project> Projects = new();
    private List<Resource> Resources = new();

    string NameFilter = string.Empty;
    string DescriptionFilter = string.Empty;
    DateTime? FromDateFilter;
    DateTime? ToDateFilter;
    string FilterString = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Projects = await ProjectService.GetProjectsAsync();
        Resources = await ResourceService.GetOrganizationResources();
    }

    bool FilterFunction(Project project)
    {
        bool nameMatches = false;
        bool descriptionMatches = false;
        bool fromMatches = false;
        bool toMatches = false;
        bool filterMatches = false;

        if (string.IsNullOrWhiteSpace(NameFilter) || project.Name.Contains(NameFilter, StringComparison.OrdinalIgnoreCase)) nameMatches = true;
        else return false;
        if (string.IsNullOrWhiteSpace(DescriptionFilter) || project.Description.Contains(DescriptionFilter, StringComparison.OrdinalIgnoreCase)) descriptionMatches = true;
        else return false;

        // throw new NotImplementedException("Filtering null-dates seems to crash the app.");


        if (string.IsNullOrWhiteSpace(FilterString)) filterMatches = true;
        if (project.Name.Contains(FilterString, StringComparison.OrdinalIgnoreCase)) filterMatches = true;
        if (project.Description != null && project.Description.Contains(FilterString, StringComparison.OrdinalIgnoreCase)) filterMatches = true;

        if (FromDateFilter is null || project.Start >= FromDateFilter) fromMatches = true;
        else return false;

        //Do this last for optimiaztion reasons.
        if (ToDateFilter is null ||  GanttDateCalculator.CalculateEnd(project, Resources)?.Date <= ToDateFilter?.Date) toMatches = true;
        else return false;

        return nameMatches && descriptionMatches && fromMatches && toMatches && filterMatches;
    }
    void ViewSelectionInGantt()
    {
        GanttViewState.SetItems(Projects.Where(p => FilterFunction(p)));
        NavigationManager.NavigateTo(Planity.FrontendBlazorWASM.Routes.ProjectGantt);
    }
}